{"variants":[{"traits":[{"interfaceLanguage":"swift"}],"paths":["\/documentation\/vigramsdk\/step4settingupbluetoothservice"]}],"metadata":{"images":[{"identifier":"logo.png","type":"icon"}],"roleHeading":"Article","role":"article","title":"Setting up Bluetooth service","modules":[{"name":"VigramSDK"}]},"sections":[],"schemaVersion":{"minor":3,"patch":0,"major":0},"primaryContentSections":[{"content":[{"anchor":"Overview","type":"heading","level":2,"text":"Overview"},{"type":"paragraph","inlineContent":[{"type":"text","text":"After completing "},{"type":"strong","inlineContent":[{"isActive":true,"type":"reference","overridingTitleInlineContent":[{"type":"text","text":"the authentication procedure."}],"identifier":"doc:\/\/com.vigram.VigramSDK\/documentation\/VigramSDK\/Step2SDKAuthentication","overridingTitle":"the authentication procedure."}]},{"type":"text","text":", and "},{"inlineContent":[{"identifier":"doc:\/\/com.vigram.VigramSDK\/documentation\/VigramSDK\/Step3ConfigurationParameters","overridingTitle":"the configuration flag settings","type":"reference","overridingTitleInlineContent":[{"type":"text","text":"the configuration flag settings"}],"isActive":true}],"type":"strong"},{"type":"text","text":" you need to create the Bluetooth service and configure it. Let’s move on to these actions."}]},{"type":"paragraph","inlineContent":[{"type":"text","text":"A BluetoothService is used to handle bluetooth connections. See "},{"type":"reference","identifier":"https:\/\/developer.apple.com\/documentation\/corebluetooth","isActive":true},{"text":" for more information.","type":"text"}]},{"name":"Note","content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"Your app will crash if its "},{"code":"Info.plist","type":"codeVoice"},{"type":"text","text":" doesn’t include usage description keys for the types of data it needs to access."},{"type":"text","text":"\n"},{"text":"To access Core Bluetooth APIs:","type":"text"}]},{"items":[{"content":[{"type":"paragraph","inlineContent":[{"text":"On apps linked on or after iOS 13, include the ","type":"text"},{"code":"NSBluetoothAlwaysUsageDescription","type":"codeVoice"},{"text":" key.","type":"text"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"On iOS 12 and earlier, include "},{"code":"NSBluetoothPeripheralUsageDescription","type":"codeVoice"},{"type":"text","text":"."}]}]}],"type":"unorderedList"}],"style":"note","type":"aside"},{"text":"Step 1. Create an instance of the BluetoothService.","level":3,"anchor":"Step-1-Create-an-instance-of-the-BluetoothService","type":"heading"},{"inlineContent":[{"type":"text","text":"This service is required to work with the smartphone’s Bluetooth module (BLE)."}],"type":"paragraph"},{"type":"codeListing","syntax":"swift","code":["    var bluetoothService = Vigram.bluetoothService()"]},{"text":"Step 2. Run a scan to find RTK devices.","level":3,"type":"heading","anchor":"Step-2-Run-a-scan-to-find-RTK-devices"},{"type":"paragraph","inlineContent":[{"text":"You need to start searching for Bluetooth devices","type":"text"}]},{"type":"codeListing","code":["    bluetoothService.startScan()"],"syntax":"swift"},{"type":"paragraph","inlineContent":[{"type":"text","text":"startScan() can be called to start the scanning process for bluetooth peripherals."}]},{"type":"paragraph","inlineContent":[{"text":"Once bluetooth capabilities are available, the service internally calls startScan() automatically.","type":"text"}]},{"type":"paragraph","inlineContent":[{"inlineContent":[{"type":"text","text":"Note:"}],"type":"strong"},{"type":"text","text":" Don’t forget to include the appropriate permissions in the .plist file above. Otherwise, bluetooth will be blocked by iOS."}]},{"inlineContent":[{"identifier":"fig13.png","type":"image"}],"type":"paragraph"},{"level":3,"anchor":"Step-3-Subscribe-to-the-observeAvailableDevices-publisher-which-provides-a-list-of-discovered-RTK-devices","type":"heading","text":"Step 3. Subscribe to the observeAvailableDevices publisher, which provides a list of discovered RTK devices."},{"inlineContent":[{"text":"It is not possible to connect directly to viDoc without using Apple system libraries. Therefore, before connecting to viDoc (Peripheral), you need to find the corresponding CBPeripheral device and connect to it using CoreBluetooth - Apple’s library for working with Bluetooth.","type":"text"}],"type":"paragraph"},{"syntax":"swift","code":["    var subscription = Set<AnyCancellable>()","    ","    \/\/ A constant that stores a reference to the device we will ","    \/\/ to connect.","    let device: CBPeripheral ","","    bluetoothService.observeAvailableDevices()","        .sink { [weak self] devices in","            \/\/ the return value stores an array of found devices","            \/\/ (if no devices are found, it will return an empty array)","            if let firstDevice = devices.first {","                \/\/ We will connect to the first device found.","                self?.device = firstDevice ","            }","        }.store(in: &subscription)"],"type":"codeListing"},{"level":3,"anchor":"Step-4-Create-a-Peripheral-instance","text":"Step 4. Create a Peripheral instance.","type":"heading"},{"type":"paragraph","inlineContent":[{"text":"Once we have found the required device (CBPeripheral instance), we can create a Peripheral instance to work with viDoc functions and connect to it.","type":"text"}]},{"code":["    \/\/ A constant that stores a reference to the device we will ","    \/\/ to connect.","    let device: CBPeripheral ","","    \/\/ A variable that stores a reference to RTK device (our viDoc)","    var peripheral = Vigram.peripheral(device)"],"type":"codeListing","syntax":"swift"},{"inlineContent":[{"text":"If you want to log viDoc’s work, create a log file.","type":"text"}],"type":"paragraph"},{"inlineContent":[{"type":"text","text":"A detailed description can be found in the "},{"type":"strong","inlineContent":[{"type":"reference","overridingTitle":"Use Peripheral Logger section.","identifier":"doc:\/\/com.vigram.VigramSDK\/documentation\/VigramSDK\/UsePeripheralLogger","overridingTitleInlineContent":[{"text":"Use Peripheral Logger section.","type":"text"}],"isActive":true}]}],"type":"paragraph"},{"syntax":"swift","code":["    \/\/ A constant that stores a reference to the device we will ","    \/\/ to connect.","    let device: CBPeripheral ","","    \/\/ A variable that stores a reference to RTK device (our viDoc)","    var peripheral: Periperal?","","    \/\/ A constant that stores a log file path","    let logFile = createLogFile(nameDevice: device.name, ","                                fileExtension: \"txt\", folder: \"LOG\")","","    \/\/ Try to create peripheral instance","    do {","        try peripheral = Vigram.peripheral(device, log: logFile)","    } catch {","        \/\/ Do something with error","    }"],"type":"codeListing"},{"inlineContent":[{"text":"If you want to use a custom configuration, create one.","type":"text"}],"type":"paragraph"},{"type":"paragraph","inlineContent":[{"type":"text","text":"For more information, see "},{"type":"strong","inlineContent":[{"overridingTitle":"Use the Peripheral Configuration.","type":"reference","overridingTitleInlineContent":[{"text":"Use the Peripheral Configuration.","type":"text"}],"identifier":"doc:\/\/com.vigram.VigramSDK\/documentation\/VigramSDK\/UsePeripheralConfiguration","isActive":true}]}]},{"type":"codeListing","syntax":"swift","code":["    \/\/ A constant that stores a reference to the device we will ","    \/\/ to connect.","    let device: CBPeripheral ","","    \/\/ A constant that stores a peripheral configuration","    let peripheralConfiguration = ","            PeripheralConfiguration(rateOfChangeMessages: .hertz7,","                                    dynamicType: .stationary)","","    \/\/ A constant that stores a reference to RTK device (our viDoc)","    let peripheral = ","            Vigram.peripheral(device, ","                              configuration: peripheralConfiguration)"]},{"inlineContent":[{"type":"text","text":"Or with logger and configuration:"}],"type":"paragraph"},{"code":["    \/\/ A variable that stores a reference to the device we will ","    \/\/ to connect.","    let device: CBPeripheral ","","    \/\/ A variable that stores a reference to RTK device (our viDoc)","    var peripheral: Periperal?","","    let peripheralConfiguration = ","        PeripheralConfiguration(rateOfChangeMessages: .hertz7,","                                dynamicType: .stationary)","","    do {","        try peripheral = ","            Vigram.peripheral(device, log: logFile,","                              configuration: peripheralConfiguration)","    } catch {","        \/\/ Do something with error","    }"],"syntax":"swift","type":"codeListing"},{"level":3,"text":"Step 5. Connecting to CBPeripheral and starting communication with Peripheral","type":"heading","anchor":"Step-5-Connecting-to-CBPeripheral-and-starting-communication-with-Peripheral"},{"inlineContent":[{"text":"After creating an instance of the Peripheral class and determining the current CBPeripheral device, it is necessary to connect to the CBPeripheral and start exchanging messages with the Peripheral.","type":"text"}],"type":"paragraph"},{"code":["\/\/ Combine publishers set","var subscription = Set<AnyCancellable>()","","\/\/ A constant that stores a reference to the device we will ","\/\/ to connect.","let device: CBPeripheral ","","\/\/ A constant that stores a reference to RTK device (our viDoc)","let peripheral: Peripheral","","\/\/ Connect to current device","bluetoothService.connect(to: device.identifier)","    .sink(receiveCompletion: { [weak self] completion in","        switch completion {","        case .finished:","            \/\/ Connect successful","            guard let self else { return }","            \/\/ Start exchanging messages with the Peripheral","            self.peripheral","                .start()","                .sink(receiveCompletion: { completion in","                    switch completion {","                    case .finished: ","                        \/\/ Successful connection. ","                        \/\/ You can send requests and read responces ","                        \/\/ from the viDoc.","                        break","                    case .failure(let error):","                        \/\/ Error connect to Peripheral","                    }","                }) { _ in }.store(in: &self.subscription)","        case .failure(let error):","            \/\/ Error connect to CBPeripheral","    }","}){ currentCBPeripheral in ","    \/\/ do something with value","}.store(in: &subscription)"],"type":"codeListing","syntax":"swift"},{"level":3,"anchor":"Step-6-Disconnecting-from-the-device","type":"heading","text":"Step 6. Disconnecting from the device"},{"inlineContent":[{"type":"text","text":"To finish working with the device, you need to break the connection."}],"type":"paragraph"},{"type":"codeListing","syntax":"swift","code":["bluetoothService.disconnect()"]},{"type":"paragraph","inlineContent":[{"text":"The full listing is presented below","type":"text"}]},{"syntax":"swift","code":["import Combine","import CoreBluetooth","import VigramSDK","","final class YouVigramHelper: NSObject {","","    \/\/ Stored properties","","    private var subscription = Set<AnyCancellable>()","    private var peripheral: Peripheral?","    private var bluetoothService: BluetoothService?","    private var currentDevice: CBPeripheral?","","    \/\/ Init","","    public init() {","        super.init()","","        \/\/ Previous step 2. Can be moved to a separate function.","        func authenticationSDK()","","        \/\/ Previous step 3. Can be moved to a separate function.","        func setDefaultParametres()","    }","","    deinit {","        subscription.removeAll()","    }","","    \/\/ Private methods","","    private func setDefaultParametres() {","        Configuration.defaultRate = .hertz7","    }","","    private func authenticationSDK() {","        Vigram.initial(token: \"Your token\")","            .check()","            .receive(on: DispatchQueue.main)","            .sink(receiveCompletion: { completion in","                switch completion {","                case .finished:","                    break","                case .failure(let error):","                    print(error.localizedDescription)","                }","            }) { [weak self] resultAuthentication in","                switch resultAuthentication {","                    case .success:","                        self?.bluetoothService = Vigram.bluetoothService()","                        self?.startScanBluetooth()","                    case .failure(let error):","                        print(error.localizedDescription)","                }","            }.store(in: &subscription)","    }","","    private func startScanBluetooth() {","        bluetoothService?.startScan()","        bluetoothService?.observeAvailableDevices()","            .sink { [weak self] devices in","                self?.currentDevice = devices.first","            }.store(in: &subscription)","    }","","    \/\/ Public methods","","    func conectToDevice() {","        let logFile = createLogFile(nameDevice: peripheral.name, ","                                    fileExtension: \"txt\", folder: \"LOG\")","","        do {","            try self.peripheral = Vigram.peripheral(peripheral,","                                                    log: logFile)","        } catch {","            print(error.localizedDescription)","        }","","        guard let currentDevice else { ","            print(\"Device not found\")","            return ","        }","","        bluetoothService?.connect(to: currentDevice.identifier)","            .sink(receiveCompletion: { [weak self] completion in","                switch completion {","                case .finished:","                    guard let self else { return }","                    self.peripheral?","                        .start()","                        .sink(receiveCompletion: { completion in","                            switch completion {","                            case .finished: ","                                break","                            case .failure(let error):","                                print(error.localizedDescription)","                            }","                        }) { _ in }.store(in: &self.subscription)","                case .failure(let error):","                    print(error.localizedDescription)","            }","        }){ _ in }.store(in: &subscription)","    }","","    func disconnect(){","        bluetoothService?.disconnect()","        peripheral = nil","        currentDevice = nil","        startScanBluetooth()","    }","}"],"type":"codeListing"},{"inlineContent":[{"text":"This completes the Setting up Bluetooth service.","type":"text"}],"type":"paragraph"},{"inlineContent":[{"text":"The next step is ","type":"text"},{"type":"strong","inlineContent":[{"overridingTitle":"Work with viDoc (Peripheral)","isActive":true,"identifier":"doc:\/\/com.vigram.VigramSDK\/documentation\/VigramSDK\/Step5WorkWithPeripheral","overridingTitleInlineContent":[{"text":"Work with viDoc (Peripheral)","type":"text"}],"type":"reference"}]}],"type":"paragraph"},{"type":"paragraph","inlineContent":[{"type":"text","text":"*All methods and functions specified in this manual are also available in the "},{"type":"reference","isActive":true,"identifier":"https:\/\/github.com\/vigram-sw\/SDK_iOS_viDoc_Distribution\/tree\/demo\/"}]},{"text":"Navigation","level":2,"type":"heading","anchor":"Navigation"},{"type":"paragraph","inlineContent":[{"identifier":"doc:\/\/com.vigram.VigramSDK\/documentation\/VigramSDK\/GettingStarted","isActive":true,"overridingTitle":"Up to Getting started with VigramSDK","type":"reference","overridingTitleInlineContent":[{"type":"text","text":"Up to Getting started with VigramSDK"}]}]},{"type":"paragraph","inlineContent":[{"isActive":true,"type":"reference","identifier":"doc:\/\/com.vigram.VigramSDK\/documentation\/VigramSDK\/Step1GettingStarted","overridingTitleInlineContent":[{"type":"text","text":"✅ STEP 1 (Import VigramSDK)"}],"overridingTitle":"✅ STEP 1 (Import VigramSDK)"}]},{"inlineContent":[{"overridingTitleInlineContent":[{"type":"text","text":"✅ STEP 2 (SDK Authentication)"}],"type":"reference","isActive":true,"overridingTitle":"✅ STEP 2 (SDK Authentication)","identifier":"doc:\/\/com.vigram.VigramSDK\/documentation\/VigramSDK\/Step2SDKAuthentication"}],"type":"paragraph"},{"type":"paragraph","inlineContent":[{"isActive":true,"identifier":"doc:\/\/com.vigram.VigramSDK\/documentation\/VigramSDK\/Step3ConfigurationParameters","overridingTitleInlineContent":[{"type":"text","text":"✅ STEP 3 (Description of configuration parameters)"}],"overridingTitle":"✅ STEP 3 (Description of configuration parameters)","type":"reference"}]},{"type":"paragraph","inlineContent":[{"inlineContent":[{"text":"✅ STEP 4 (Setting up Bluetooth service)","type":"text"}],"type":"strong"}]},{"type":"paragraph","inlineContent":[{"overridingTitleInlineContent":[{"text":"STEP 5 (Work with viDoc (Peripheral))","type":"text"}],"type":"reference","isActive":true,"identifier":"doc:\/\/com.vigram.VigramSDK\/documentation\/VigramSDK\/Step5WorkWithPeripheral","overridingTitle":"STEP 5 (Work with viDoc (Peripheral))"}]},{"type":"paragraph","inlineContent":[{"identifier":"doc:\/\/com.vigram.VigramSDK\/documentation\/VigramSDK\/Step6UsingNTRIP","overridingTitle":"STEP 6 (Using NTRIP correction)","type":"reference","isActive":true,"overridingTitleInlineContent":[{"text":"STEP 6 (Using NTRIP correction)","type":"text"}]}]},{"inlineContent":[{"identifier":"doc:\/\/com.vigram.VigramSDK\/documentation\/VigramSDK\/Step7LaserService","isActive":true,"overridingTitleInlineContent":[{"type":"text","text":"STEP 7 (Using LaserService)"}],"overridingTitle":"STEP 7 (Using LaserService)","type":"reference"}],"type":"paragraph"},{"inlineContent":[{"overridingTitleInlineContent":[{"type":"text","text":"STEP 8 (Using SinglePoint Measurements)"}],"overridingTitle":"STEP 8 (Using SinglePoint Measurements)","isActive":true,"type":"reference","identifier":"doc:\/\/com.vigram.VigramSDK\/documentation\/VigramSDK\/Step8SinglePoint"}],"type":"paragraph"}],"kind":"content"}],"hierarchy":{"paths":[["doc:\/\/com.vigram.VigramSDK\/documentation\/VigramSDK"]]},"kind":"article","identifier":{"interfaceLanguage":"swift","url":"doc:\/\/com.vigram.VigramSDK\/documentation\/VigramSDK\/Step4SettingUpBluetoothService"},"references":{"doc://com.vigram.VigramSDK/documentation/VigramSDK/UsePeripheralConfiguration":{"role":"article","identifier":"doc:\/\/com.vigram.VigramSDK\/documentation\/VigramSDK\/UsePeripheralConfiguration","abstract":[],"url":"\/documentation\/vigramsdk\/useperipheralconfiguration","kind":"article","type":"topic","title":"Use Peripheral Configuration","images":[{"identifier":"logo.png","type":"icon"}]},"doc://com.vigram.VigramSDK/documentation/VigramSDK/Step8SinglePoint":{"role":"article","abstract":[],"identifier":"doc:\/\/com.vigram.VigramSDK\/documentation\/VigramSDK\/Step8SinglePoint","kind":"article","url":"\/documentation\/vigramsdk\/step8singlepoint","type":"topic","title":"Using Single point measurements","images":[{"type":"icon","identifier":"logo.png"}]},"doc://com.vigram.VigramSDK/documentation/VigramSDK/Step1GettingStarted":{"role":"article","identifier":"doc:\/\/com.vigram.VigramSDK\/documentation\/VigramSDK\/Step1GettingStarted","abstract":[],"url":"\/documentation\/vigramsdk\/step1gettingstarted","kind":"article","type":"topic","title":"Import VigramSDK","images":[{"identifier":"logo.png","type":"icon"}]},"https://github.com/vigram-sw/SDK_iOS_viDoc_Distribution/tree/demo/":{"title":"Demo repository","url":"https:\/\/github.com\/vigram-sw\/SDK_iOS_viDoc_Distribution\/tree\/demo\/","type":"link","identifier":"https:\/\/github.com\/vigram-sw\/SDK_iOS_viDoc_Distribution\/tree\/demo\/","titleInlineContent":[{"text":"Demo repository","type":"text"}]},"fig13.png":{"variants":[{"traits":["1x","light"],"url":"\/images\/com.vigram.VigramSDK\/fig13.png"}],"identifier":"fig13.png","alt":"Fig.1","type":"image"},"doc://com.vigram.VigramSDK/documentation/VigramSDK/Step2SDKAuthentication":{"role":"article","identifier":"doc:\/\/com.vigram.VigramSDK\/documentation\/VigramSDK\/Step2SDKAuthentication","abstract":[],"url":"\/documentation\/vigramsdk\/step2sdkauthentication","kind":"article","type":"topic","title":"SDK Authentication","images":[{"identifier":"logo.png","type":"icon"}]},"https://developer.apple.com/documentation/corebluetooth":{"title":"CoreBluetooth","url":"https:\/\/developer.apple.com\/documentation\/corebluetooth","type":"link","identifier":"https:\/\/developer.apple.com\/documentation\/corebluetooth","titleInlineContent":[{"type":"text","text":"CoreBluetooth"}]},"doc://com.vigram.VigramSDK/documentation/VigramSDK/Step3ConfigurationParameters":{"role":"article","identifier":"doc:\/\/com.vigram.VigramSDK\/documentation\/VigramSDK\/Step3ConfigurationParameters","abstract":[],"url":"\/documentation\/vigramsdk\/step3configurationparameters","kind":"article","type":"topic","title":"Description of configuration parameters","images":[{"identifier":"logo.png","type":"icon"}]},"doc://com.vigram.VigramSDK/documentation/VigramSDK/UsePeripheralLogger":{"kind":"article","images":[{"type":"icon","identifier":"logo.png"}],"type":"topic","identifier":"doc:\/\/com.vigram.VigramSDK\/documentation\/VigramSDK\/UsePeripheralLogger","title":"Use Peripheral Logger","role":"article","abstract":[],"url":"\/documentation\/vigramsdk\/useperipherallogger"},"doc://com.vigram.VigramSDK/documentation/VigramSDK/Step5WorkWithPeripheral":{"role":"article","abstract":[],"identifier":"doc:\/\/com.vigram.VigramSDK\/documentation\/VigramSDK\/Step5WorkWithPeripheral","kind":"article","url":"\/documentation\/vigramsdk\/step5workwithperipheral","type":"topic","title":"Work with viDoc (Peripheral)","images":[{"identifier":"logo.png","type":"icon"}]},"doc://com.vigram.VigramSDK/documentation/VigramSDK":{"role":"collection","title":"VigramSDK","kind":"symbol","images":[{"identifier":"logo.png","type":"icon"}],"abstract":[],"url":"\/documentation\/vigramsdk","type":"topic","identifier":"doc:\/\/com.vigram.VigramSDK\/documentation\/VigramSDK"},"doc://com.vigram.VigramSDK/documentation/VigramSDK/GettingStarted":{"identifier":"doc:\/\/com.vigram.VigramSDK\/documentation\/VigramSDK\/GettingStarted","title":"Getting Started with VigramSDK","kind":"article","url":"\/documentation\/vigramsdk\/gettingstarted","images":[{"identifier":"logo.png","type":"icon"}],"type":"topic","role":"article","abstract":[]},"doc://com.vigram.VigramSDK/documentation/VigramSDK/Step6UsingNTRIP":{"role":"article","abstract":[],"identifier":"doc:\/\/com.vigram.VigramSDK\/documentation\/VigramSDK\/Step6UsingNTRIP","kind":"article","url":"\/documentation\/vigramsdk\/step6usingntrip","type":"topic","title":"Using NTRIP correction","images":[{"type":"icon","identifier":"logo.png"}]},"logo.png":{"variants":[{"traits":["1x","light"],"url":"\/images\/com.vigram.VigramSDK\/logo.png"}],"identifier":"logo.png","alt":"Vigram logo.","type":"image"},"doc://com.vigram.VigramSDK/documentation/VigramSDK/Step7LaserService":{"abstract":[],"url":"\/documentation\/vigramsdk\/step7laserservice","identifier":"doc:\/\/com.vigram.VigramSDK\/documentation\/VigramSDK\/Step7LaserService","images":[{"type":"icon","identifier":"logo.png"}],"role":"article","kind":"article","type":"topic","title":"Using Laser service"}}}